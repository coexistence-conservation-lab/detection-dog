---
title: "Evaluation of detection dog"
author: "Shoshana Rapley"
date: "10 April 2025"
output:
  html_document:
    toc: true
    number_sections: true
    toc_depth: 3
    toc_float:
      collapsed: true
    theme: cerulean
    highlight: pygments
editor_options:
  chunk_output_type: console
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding=encoding, output_file=file.path(dirname(inputFile), 'tutorial.html')) })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, eval=TRUE)

pacman::p_load(broom, pROC, pwr, tidyverse)
```


# Power Analysis

## Dog only 

How many trials needed to determine dog performs better than sensitivity 0.5?

Premise being if the dog finds it 50% of the time it could be chance. 

However, since human searches are successful <50% of the time, 0.5 might not be the right null hypothesis value. But an okay place to start. 

```{r}
# Function to calculate required sample size for proportion test
dog_sensitivity_power <- function(
  target_sensitivity = 0.8,   # Predicted sensitivity (true positive rate)
  null_sensitivity = 0.5,     # Null hypothesis value 
  power = 0.8,               # Desired power
  alpha = 0.05,              # Significance level
  alternative = "greater"    # One sided test
) {
  
  # Effect size calculation (h) for proportion test
  h <- ES.h(p1 = target_sensitivity, p2 = null_sensitivity)
  
  # Calculate required sample size using pwr.p.test
  result <- pwr.p.test(h = h, 
                     sig.level = alpha, 
                     power = power,
                     alternative = alternative)
  
  # Return sample size (rounded up)
  return(ceiling(result$n))
}

# Create a function to explore different sensitivity scenarios
sensitivity_scenarios <- function(
  sensitivities = seq(0.7, 0.95, by = 0.05),
  null_values = c(0.5),
  power_values = c(0.8),
  alpha = 0.05
) {
  
  # Create a grid of all combinations
  scenarios <- expand_grid(
    target_sensitivity = sensitivities,
    null_sensitivity = null_values,
    power = power_values,
    alpha = alpha
  )
  
  # Calculate required sample size for each combination
  scenarios <- scenarios %>%
    rowwise() %>%
    mutate(sample_size = dog_sensitivity_power(
      target_sensitivity = target_sensitivity,
      null_sensitivity = null_sensitivity,
      power = power,
      alpha = alpha
    )) %>%
    ungroup()
  
  return(scenarios)
}

# Generate scenarios
scenarios <- sensitivity_scenarios()

# Plot
ggplot(scenarios, 
       aes(x = target_sensitivity, y = sample_size, label  = sample_size)) +
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_text(hjust = -1, vjust = -0.1)+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(title = "Required Sample Size for Detection Dog Sensitivity Testing",
    subtitle = "Compared to sensitivity 0.5",
    x = "Target Sensitivity",
    y = "Required Number of Trials") +
  theme_minimal()
```

## Dog and human

How many trials needed to determine dog performs better than human?

This is probably the better way to go, because the purpose of the study is to demonstrate that the dog is better than alternative methods - which in this case is human search. In other dog studies alternative methods might be, for example, live trapping or thermal camera imaging. 

Requires estimation of expected true positive rate for the dog and the human. To date, Koda's sensitivty is around 80%. Harder to estimate for the human but lower than 50% is realistic. 

```{r}
compare_sensitivity_power <- function(
  dog_sensitivity = 0.8,    # Expected dog sensitivity
  human_sensitivity = 0.3,  # Expected human sensitivity
  power = 0.8,              # Desired power )
  alpha = 0.05,             # Significance level
  alternative = "greater"   # One-sided dog > human
) {
  
  # Effect size calculation (h) for proportion test
  h <- ES.h(p1 = dog_sensitivity, p2 = human_sensitivity)
  
  # Calculate required sample size using pwr.2p.test
  # This function is for two proportions with equal sample sizes
  result <- pwr.2p.test(h = h, 
                        n = NULL,
                        sig.level = alpha, 
                        power = power,
                        alternative = alternative)
  
  # Return sample size (rounded up)
  # For pwr.2p.test, n1 = n2 = n (equal sample sizes)
  sample_size = ceiling(result$n)
  
  return(list(
    n1 = sample_size,  # Dog sample size
    n2 = sample_size   # Human sample size
  ))
}

# Create a function to explore different comparison scenarios
comparison_scenarios <- function(
  dog_sensitivities = seq(0.7, 0.9, by = 0.1),
  human_sensitivities = seq(0.1, 0.4, by = 0.1),
  power_values = c(0.8),
  alpha = 0.05
) {
  
  # Create a grid of all combinations
  scenarios <- expand_grid(
    dog_sensitivity = dog_sensitivities,
    human_sensitivity = human_sensitivities,
    power = power_values,
    alpha = alpha
  )
  
  # Calculate required sample size for each combination
  scenarios <- scenarios %>%
    rowwise() %>%
    mutate(
      sample_result = list(compare_sensitivity_power(
        dog_sensitivity = dog_sensitivity,
        human_sensitivity = human_sensitivity,
        power = power,
        alpha = alpha
      )),
      dog_sample = sample_result$n1,
      human_sample = sample_result$n2
    ) %>%
    select(-sample_result) %>%
    ungroup()
  
  return(scenarios)
}

# Generate dog vs human comparison scenarios
comparison <- comparison_scenarios()

# Create a visualization of the comparison scenarios
ggplot(comparison, 
       aes(x = human_sensitivity, y = dog_sample, label = dog_sample))+
  geom_line(linewidth = 1) +
  geom_point(size = 3) +
  geom_text(hjust = 1.5, vjust = -0.5)+
  scale_x_continuous(labels = scales::percent_format(accuracy = 1)) +
  xlim(c(0.05, 0.45))+
  labs(
    title = "Required Sample Size for Dog vs Human Sensitivity Comparison",
    subtitle = "Facet grouped by dog sensitivity",
    x = "Human Sensitivity",
    y = "Required Number of Trials (per group)",
    colour = "Human Sensitivity",
    linetype = "Statistical Power"
  ) +
  theme_bw()+
  facet_wrap(~dog_sensitivity)
```
